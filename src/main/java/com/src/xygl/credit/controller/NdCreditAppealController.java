/*
 * Copyright© 2003-2016 浙江汇信科技有限公司, All Rights Reserved. 
 */
package com.icinfo.ndrc.credit.controller;

import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import com.icinfo.ndrc.credit.dto.NdCreditAppealDto;
import com.icinfo.ndrc.credit.model.NdCreditAppeal;
import com.icinfo.ndrc.credit.model.NdVerifyCode;
import com.icinfo.ndrc.credit.service.INdCreditAppealService;
import com.icinfo.ndrc.credit.service.INdVerifyCodeService;
import com.icinfo.ndrc.support.Constants;
import com.icinfo.ndrc.system.model.SysUser;
import com.icinfo.ndrc.util.FileUtil;
import com.icinfo.ndrc.util.RequestUtil;
import com.icinfo.ndrc.util.UUIDUtils;
import com.icinfo.framework.common.ajax.AjaxResult;
import com.icinfo.framework.core.web.BaseController;
import com.icinfo.framework.mybatis.pagehelper.datatables.PageRequest;
import com.icinfo.framework.mybatis.pagehelper.datatables.PageResponse;

/**
 * 描述:    nd_credit_appeal 对应的Controller类.<br>
 *
 * @author framework generator
 * @date 2017年06月08日
 */
@Controller
@RequestMapping({"/credit/appeal","/gateway/reception/appeal"})
public class NdCreditAppealController extends BaseController {
	
	@Autowired
	INdCreditAppealService ndCreditAppealService;
	
	@Autowired
	INdVerifyCodeService ndVerifyCodeService;
	/**
	 * 进入异议申诉页面
	 * @author zjj
	 * 20170608
	 */
	@RequestMapping(value = "views", method = RequestMethod.GET)
	public ModelAndView views(HttpSession session) throws Exception {
		SysUser user = (SysUser) session.getAttribute(Constants.SESSION_SYS_USER);
		ModelAndView mv = new ModelAndView("credit/system/creditappeal_list");
		mv.addObject("user",user);
		return mv;
	}
	/**
	 * 上传接口（兼容IE8）
	 * @param files
	 * @param batchNo
	 * @param fileName
	 * @return
	 */
	@RequestMapping(value = "/upload", method = RequestMethod.POST, produces = "text/html;charset=UTF-8")
	@ResponseBody
	public String upload(@RequestParam(value = "btnFile") MultipartFile files,String fileName) throws Exception{

		return ndCreditAppealService.upload(files,fileName);
	}

	/**
	 * 视频上传接口（兼容IE8）
	 * @param files
	 * @param batchNo
	 * @param fileName
	 * @return
	 */
	@RequestMapping(value = "/uploadvideo", method = RequestMethod.POST, produces = "text/html;charset=UTF-8")
	@ResponseBody
	public String uploadvideo(@RequestParam(value = "btnFile") MultipartFile files,String fileName,HttpServletRequest request) throws Exception{

		return ndCreditAppealService.uploadvideo(files,fileName,request);
	}

   	/**
   	 * 下载文件
   	 * @param fileName
   	 * @return
   	 */
	@RequestMapping(value = "/download", method = RequestMethod.GET)
   	public ResponseEntity<byte[]> download(String fileName) throws Exception{
        
		return ndCreditAppealService.download(fileName);
   	}
   	/**
   	 * 保存信用申诉
   	 * @author zjj
   	 * 20170612
   	 * @throws Exception
   	 */
    @RequestMapping(value = "save", method = RequestMethod.POST)
    @ResponseBody
    public AjaxResult register(@                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Valid NdCreditAppealDto ndCreditAppealDto) throws Exception{
    	Map<String,Object> qryMap = new HashMap<String,Object>();
    	qryMap.put("tel", ndCreditAppealDto.getTel());
    	List<NdVerifyCode> list = ndVerifyCodeService.selectVerifyCode(qryMap);
    	
    	if(list.size() == 0 || !ndCreditAppealDto.getCheckCode().equals(list.get(0).getVerCode()))
    		return AjaxResult.error("验证码错误");
    	
    	ndCreditAppealDto.setCreateTime(new Date());
    	ndCreditAppealDto.setEndState("1");
    	if(ndCreditAppealService.insert(ndCreditAppealDto)>0)
    		return AjaxResult.success("提交成功");
    	return AjaxResult.error("保存失败");
    }
    
    /**
     * 进入异议申诉受理
     * @author zjj
     */
    @RequestMapping(value = "checkViews", method = RequestMethod.GET)
    public ModelAndView checkViews(HttpSession session) throws Exception{
    	SysUser user = (SysUser) session.getAttribute(Constants.SESSION_SYS_USER);
    	ModelAndView mv = new ModelAndView("credit/system/creditappealcheck_list");
    	mv.addObject("user",user);
    	return mv;
    }
    /**
     * 获取异议申诉数据
     * @author zjj
     * 20170612
     */
    @RequestMapping({ "/appeallist.json" })
	@ResponseBody
    public PageResponse<NdCreditAppealDto> listJson(PageRequest request) throws Exception{
    	List<NdCreditAppealDto> data = ndCreditAppealService.doGetList(request);
    	return new PageResponse<NdCreditAppealDto>(data);
    }
    /**
     * 进入申诉详情
     * @author zjj
     */
    @RequestMapping(value = "detail", method = RequestMethod.GET)
    public ModelAndView detail(String uid) throws Exception{
    	ModelAndView mv = new ModelAndView("credit/system/creditappeal_detail");
    	if(StringUtils.isBlank(uid)) return mv;
    	
    	Map<String,Object> qryMap = new HashMap<String,Object>();
    	qryMap.put("uid", uid);
    	List<NdCreditAppealDto> list = ndCreditAppealService.selectList(qryMap);
    	
    	if(list.size()>0)
    		mv.addObject("ndCreditAppeal",list.get(0));
		return mv;
    }
    /**
     * 弹出反馈界面
     * @author fanzhen
     * @date 2017-06-14
     * @param req
     * @return
     * @throws Exception
     */
    @RequestMapping(value="gofeedback",method=RequestMethod.GET)
    public String gofeedback(String uid,HttpServletRequest req) throws Exception{
    	req.setAttribute("uid", uid);
    	Map<String,Object> map = new HashMap<String,Object>();
    	map.put("uid", uid);
    	NdCreditAppeal ndCreditAppeal = ndCreditAppealService.selectList(map).get(0);
    	req.setAttribute("ndCreditAppeal", ndCreditAppeal);
    	return "credit/system/feedback";
    }
    /**
     * 反馈处理 
     * @author fanzhen
     * @date 20170614
     * @return
     * @throws Exception
     */
    @RequestMapping(value="feedback",method=RequestMethod.POST)
    @ResponseBody
    public AjaxResult feedback(NdCreditAppealDto dto,HttpServletRequest req) throws Exception{
    	Map<String,Object> map = new HashMap<String,Object>();
    	map.put("uid", dto.getUid());
    	NdCreditAppeal ndCreditAppeal = ndCreditAppealService.selectList(map).get(0);
    	SysUser sysUser = (SysUser)req.getSession().getAttribute(Constants.SESSION_SYS_USER);
    	ndCreditAppeal.setHandlePerson(sysUser.getUsername());
    	ndCreditAppeal.setHandleId(sysUser.getUid());
    	ndCreditAppeal.setHandleTime(new Date());
    	ndCreditAppeal.setEndState("2");
    	ndCreditAppeal.setHandleRemark(dto.getHandleRemark());
    	ndCreditAppeal.setHandleResult(dto.getHandleResult());
    	int i = ndCreditAppealService.UpdateNdCreditAppealDto(ndCreditAppeal);
    	if(i==1){
    		return AjaxResult.success("反馈成功");
    	}
    	return AjaxResult.error("反馈失败，请稍后重试");
    }
    /**
     * 批量下载
     * @author zjj
     */
    @RequestMapping(value = "/export", method = RequestMethod.GET)
    public ResponseEntity<byte[]> export(String proveMaterial) throws Exception{
    	String uid = UUIDUtils.randomUUID();
    	String zipPath = ndCreditAppealService.downloadFile(uid,proveMaterial);
    	return FileUtil.downFromLoc(uid + ".zip" , RequestUtil.getRequest() , zipPath);
    }
}